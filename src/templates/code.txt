var $background, $backgroundItems, $code, $codeMask, $content, $fgFacebookLink, $fgTwitterLink, $firstForegroundItem, $footer, $foreground, $foregroundItems, $halfViewportHeights, $headerBackgrounds, $headerLogo, $mainArrow, $mainHeader, $scroller, $viewportHeights, $wrapper, CONTENT_GAP_PERCENT_OF_VIEWPORT, END_OFFSET, FADE_GAP_OF_BLACK, GAP_PERCENT_OF_VIEWPORT, MID_FADE_PERCENT, MIXPANEL_ID, SCROLL_TO_EL_TIME, TOTAL_HEADER_BACKGROUNDS, cacheElements, contentGap, endOffest, fadeBetweenForegroundItems, fadeInFirstForegroundItem, fadeOutHeaderImage, init, myScroll, offset, onClickHeaderDownArrow, onResize, onScroll, popLockCodeMask, popLockForeground, renderHeaderBackgrounds, renderSocialShares, scrollTop, setBackgroundItemGap, setContentGap, setHeaderSize, setScrollTop, setupIScroll, shareOnFacebook, shareOnTwitter, startOffest, transitionHeaderBackground, viewportHeight;

MIXPANEL_ID = "297ce2530b6c87b16195b5fb6556b38f";

TOTAL_HEADER_BACKGROUNDS = 3;

SCROLL_TO_EL_TIME = 700;

GAP_PERCENT_OF_VIEWPORT = 0.5;

CONTENT_GAP_PERCENT_OF_VIEWPORT = 0.8;

MID_FADE_PERCENT = 0.5;

FADE_GAP_OF_BLACK = 0.6;

startOffest = function(vpHeight) {
  return 0;
};

END_OFFSET = 1.1;

endOffest = function(vpHeight) {
  return vpHeight * END_OFFSET;
};

$scroller = null;

$backgroundItems = null;

$foreground = null;

$mainHeader = null;

$content = null;

$wrapper = null;

$mainArrow = null;

$foregroundItems = null;

$footer = null;

$background = null;

$fgFacebookLink = null;

$fgTwitterLink = null;

$headerLogo = null;

$headerBackgrounds = null;

$firstForegroundItem = null;

$viewportHeights = null;

$halfViewportHeights = null;

$codeMask = null;

$code = null;

myScroll = null;

contentGap = 0;

scrollTop = 0;

viewportHeight = 0;

init = function() {
  renderHeaderBackgrounds();
  cacheElements();
  $(window).on('resize', onResize);
  onResize();
  setupIScroll();
  $mainArrow.click(onClickHeaderDownArrow);
  $mainArrow.on('tap', onClickHeaderDownArrow);
  $fgFacebookLink.click(shareOnFacebook);
  $fgTwitterLink.click(shareOnTwitter);
  setContentGap();
  transitionHeaderBackground();
  renderSocialShares();
  mixpanel.init(MIXPANEL_ID);
  return mixpanel.track("Viewed page");
};

renderHeaderBackgrounds = function() {
  var i;
  $('#header-background ul').html(((function() {
    var _i, _results;
    _results = [];
    for (i = _i = 0; 0 <= TOTAL_HEADER_BACKGROUNDS ? _i <= TOTAL_HEADER_BACKGROUNDS : _i >= TOTAL_HEADER_BACKGROUNDS; i = 0 <= TOTAL_HEADER_BACKGROUNDS ? ++_i : --_i) {
      _results.push("<li style='background-image: url(images/header/" + i + ".jpg)'></li>");
    }
    return _results;
  })()).join(''));
  return $('#header-background li').first().show();
};

renderSocialShares = function() {
  var shareUrl;
  shareUrl = "http://2013.artsy.net/" || location.href;
  $.ajax({
    url: "http://api.facebook.com/restserver.php?method=links.getStats&urls[]=" + shareUrl,
    success: function(res) {
      return $('#social-button-facebook-count').html($(res).find('share_count').text() || 0).show();
    }
  });
  window.twitterCountJSONPCallback = function(res) {
    if (res.count == null) {
      return;
    }
    return $('#social-button-twitter-count').html(res.count || 0).show();
  };
  return $.ajax({
    url: "http://urls.api.twitter.com/1/urls/count.json?url=" + shareUrl + "&callback=twitterCountJSONPCallback",
    dataType: 'jsonp'
  });
};

setupIScroll = function() {
  $wrapper.height(viewportHeight);
  myScroll = new IScroll('#wrapper', {
    probeType: 3,
    mouseWheel: true
  });
  myScroll.on('scroll', setScrollTop);
  myScroll.on('scrollEnd', setScrollTop);
  myScroll.on('scroll', onScroll);
  myScroll.on('scrollEnd', onScroll);
  return document.addEventListener('touchmove', (function(e) {
    return e.preventDefault();
  }), false);
};

cacheElements = function() {
  $scroller = $('#scroller');
  $backgroundItems = $('#background-content > li');
  $foreground = $('#foreground');
  $foregroundItems = $("#foreground li");
  $mainHeader = $('#main-header');
  $content = $('#content');
  $wrapper = $('#wrapper');
  $mainArrow = $('#main-header-down-arrow');
  $footer = $('#footer');
  $background = $('#background');
  $fgFacebookLink = $('#foreground .social-button-facebook');
  $fgTwitterLink = $('#foreground .social-button-twitter');
  $headerBackgrounds = $('#header-background li');
  $headerLogo = $('#main-header-logo');
  $firstForegroundItem = $('#foreground li:first-child');
  $viewportHeights = $('.viewport-height');
  $halfViewportHeights = $('.half-viewport-height');
  $codeMask = $('#background-code-mask');
  return $code = $('#background-code');
};

offset = function($el) {
  var top, _ref, _ref1, _ref2;
  top = -(((_ref = $scroller.offset()) != null ? _ref.top : void 0) - ((_ref1 = $el.offset()) != null ? _ref1.top : void 0));
  return {
    top: top,
    left: (_ref2 = $el.offset()) != null ? _ref2.left : void 0,
    bottom: top + $el.height()
  };
};

onClickHeaderDownArrow = function() {
  myScroll.scrollToElement('#content', 1200, null, null, IScroll.utils.ease.quadratic);
  return false;
};

shareOnFacebook = function(e) {
  var opts, url;
  mixpanel.track("Shared on Facebook");
  opts = "status=1,width=750,height=400,top=249.5,left=1462";
  url = "https://www.facebook.com/sharer/sharer.php?u=" + location.href;
  window.open(url, 'facebook', opts);
  return false;
};

shareOnTwitter = function(e) {
  var $curHeader, opts, text, url;
  mixpanel.track("Shared on Twitter");
  opts = "status=1,width=750,height=400,top=249.5,left=1462";
  $curHeader = $("#foreground li[data-slug='" + (location.hash.replace('#', '')) + "'] h1");
  text = encodeURIComponent($curHeader.text() + ' | ' + $('title').text());
  url = "https://twitter.com/intent/tweet?" + ("original_referer=" + location.href) + ("&text=" + text) + ("&url=" + location.href);
  window.open(url, 'twitter', opts);
  return false;
};

onScroll = function() {
  popLockForeground();
  fadeBetweenForegroundItems();
  fadeOutHeaderImage();
  fadeInFirstForegroundItem();
  return popLockCodeMask();
};

setScrollTop = function() {
  return scrollTop = -(this.y >> 0);
};

fadeBetweenForegroundItems = function() {
  return $backgroundItems.each(function() {
    var $curItem, $nextItem, elBottom, elTop, endPoint, firstMidPoint, index, midPoint, nextTop, percentNextItem, percentPrevItem, startPoint, viewportBottom;
    index = $(this).index();
    $curItem = $foregroundItems.eq(index);
    $nextItem = $foregroundItems.eq(index + 1);
    viewportBottom = scrollTop + viewportHeight;
    elTop = offset($(this)).top;
    elBottom = offset($(this)).bottom;
    nextTop = offset($(this).next()).top;
    startPoint = elBottom + startOffest(viewportHeight);
    endPoint = nextTop + endOffest(viewportHeight);
    midPoint = (endPoint - startPoint) * MID_FADE_PERCENT + startPoint;
    firstMidPoint = midPoint - (viewportHeight * GAP_PERCENT_OF_VIEWPORT) * FADE_GAP_OF_BLACK;
    if (scrollTop > elTop && viewportBottom < elBottom) {
      $foregroundItems.removeClass('foreground-item-active');
      return $curItem.css({
        opacity: 1
      }).addClass('foreground-item-active');
    } else if (viewportBottom > startPoint && viewportBottom < endPoint) {
      percentPrevItem = 1 - (viewportBottom - startPoint) / (firstMidPoint - startPoint);
      percentNextItem = (viewportBottom - midPoint) / (endPoint - midPoint);
      $curItem.css({
        opacity: percentPrevItem
      });
      return $nextItem.css({
        opacity: percentNextItem
      });
    }
  });
};

fadeOutHeaderImage = function() {
  $('#header-background').css({
    opacity: 1 - (scrollTop / viewportHeight)
  });
  return $('#header-background-gradient').css({
    opacity: (scrollTop / viewportHeight) * 2
  });
};

popLockForeground = function() {
  var top, x;
  top = scrollTop - contentGap;
  x = offset($background).bottom - viewportHeight - contentGap;
  top = Math.min(top, x);
  return $foreground.css({
    top: Math.max(0, top)
  });
};

transitionHeaderBackground = function() {
  $headerLogo.addClass('active');
  return setTimeout(function() {
    return setTimeout(function() {
      var $cur, $next, index, nextIndex;
      index = $($headerBackgrounds.filter(function() {
        return $(this).hasClass('active');
      })[0]).index();
      nextIndex = index + 1 >= TOTAL_HEADER_BACKGROUNDS ? 0 : index + 1;
      $cur = $($headerBackgrounds.eq(index));
      $next = $($headerBackgrounds.eq(nextIndex));
      $cur.removeClass('active');
      $next.addClass('active');
      return transitionHeaderBackground();
    }, 700);
  }, 1000);
};

popLockCodeMask = function() {
  var codeBottom, codeTop, maskTop;
  codeTop = offset($code).top;
  codeBottom = offset($code).bottom;
  if (scrollTop < codeTop || (scrollTop + viewportHeight) > codeBottom) {
    return;
  }
  maskTop = scrollTop - codeTop;
  return $codeMask.css({
    'margin-top': maskTop
  });
};

fadeInFirstForegroundItem = function() {
  var end, opacity, start;
  end = offset($firstForegroundItem).top;
  if (scrollTop >= end) {
    return;
  }
  start = offset($firstForegroundItem).top - (viewportHeight / 2);
  opacity = (scrollTop - start) / (end - start);
  return $firstForegroundItem.css({
    opacity: opacity
  });
};

onResize = function() {
  viewportHeight = $(window).height();
  setBackgroundItemGap();
  setContentGap();
  setHeaderSize();
  $viewportHeights.height(viewportHeight);
  return $halfViewportHeights.height(viewportHeight / 2);
};

setHeaderSize = function() {
  return $('#header-background').height(viewportHeight);
};

setContentGap = function() {
  $content.css({
    'margin-top': viewportHeight * CONTENT_GAP_PERCENT_OF_VIEWPORT
  });
  return contentGap = offset($content).top;
};

setBackgroundItemGap = function() {
  $backgroundItems.css({
    'margin-bottom': viewportHeight * GAP_PERCENT_OF_VIEWPORT
  });
  return $backgroundItems.last().css({
    'margin-bottom': 0
  });
};

$(function() {
  return imagesLoaded('body', init);
});
RunLink